<!-- 
  äº¤äº’å¼å…³ç³»å›¾è°±
  å¼€æºåè®®ï¼šMIT License
  ä»“åº“åœ°å€ï¼šhttps://github.com/imgsr/dzpdd3js
  ä½œè€…ï¼šD3.js
-->
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Taçš„å…³ç³»å›¾è°±</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
body{margin:0;padding:0;background:linear-gradient(135deg,#e0f0ff,#c5e3ff);font-family:"Microsoft YaHei",sans-serif;overflow:hidden;}
.container{position:relative;width:100vw;height:100vh;}
#graph{width:100%;height:100%;}
.header{position:absolute;top:20px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,.85);border-radius:20px;padding:15px 30px;box-shadow:0 5px 15px rgba(0,0,0,.1);z-index:100;display:flex;align-items:center;justify-content:center;flex-direction:column;max-width:400px;border:2px solid #4a90e2;}
.header-main{display:flex;align-items:center;margin-bottom:8px;}
.user-avatar{width:60px;height:60px;border-radius:50%;margin-right:15px;border:3px solid #ff7979;background:#f0f8ff;display:flex;align-items:center;justify-content:center;color:#ff7979;font-weight:bold;object-fit:cover;}
.user-info h2{margin:0;color:#333;font-size:20px;font-weight:bold;}
.user-title{color:#ff6b6b;font-size:14px;margin-top:5px;font-weight:bold;}
.intimacy-display{background:linear-gradient(to right,#ff9a9e,#fad0c4);border-radius:15px;padding:5px 15px;margin-top:10px;color:white;font-weight:bold;font-size:14px;box-shadow:0 3px 6px rgba(0,0,0,.1);}
.legend{position:absolute;bottom:20px;left:20px;background:rgba(255,255,255,.85);border-radius:15px;padding:15px;box-shadow:0 5px 15px rgba(0,0,0,.1);z-index:100;max-width:250px;}
.legend h3{margin:0 0 10px 0;color:#333;font-size:16px;}
.legend-item{display:flex;align-items:center;margin-bottom:8px;font-size:14px;}
.legend-color{width:20px;height:20px;border-radius:50%;margin-right:10px;border:2px solid white;}
.node{cursor:pointer;filter:drop-shadow(0 3px 5px rgba(0,0,0,.2));}
.tooltip{position:absolute;background:rgba(255,255,255,.95);border-radius:12px;padding:15px;box-shadow:0 8px 20px rgba(0,0,0,.15);max-width:250px;z-index:100;opacity:0;transition:opacity .3s;border:1px solid #ddd;pointer-events:none;}
.tooltip-header{display:flex;align-items:center;margin-bottom:10px;border-bottom:1px solid #eee;padding-bottom:10px;}
.tooltip-avatar{width:50px;height:50px;border-radius:50%;margin-right:10px;border:2px solid #4a90e2;object-fit:cover;}
.tooltip-name{font-weight:bold;font-size:18px;color:#333;}
.tooltip-title{color:#ff7979;font-size:14px;margin-top:3px;}
.tooltip-info{padding-top:8px;color:#666;font-size:14px;line-height:1.5;}
.bg-element{position:absolute;opacity:.08;z-index:1;pointer-events:none;}
.avatar-container{width:100%;height:100%;display:flex;align-items:center;justify-content:center;border-radius:50%;overflow:hidden;background:#f0f8ff;}
.avatar-image{width:100%;height:100%;object-fit:cover;}
</style>
</head>
<body>
<div class="container">
  <div id="bg-elements"></div>
  <div class="header">
    <div class="header-main">
      <img class="user-avatar" src="https://via.placeholder.com/60?text=ä¸»ç”¨æˆ·" alt="ä¸»ç”¨æˆ·å¤´åƒ">
      <div class="user-info">
        <h2>å¼ ä¸‰</h2>
        <div class="user-title">æ— æ•Œæˆ˜ç¥</div>
      </div>
    </div>
    <div class="intimacy-display">äº²å¯†åº¦æ»¡100çš„å¥½å‹æ‰èƒ½å‡ºç°åœ¨å…³ç³»å›¾è°±</div>
  </div>
  <div class="legend">
    <h3>å…³ç³»å›¾ä¾‹</h3>
    <div class="legend-item"><div class="legend-color" style="background:#ff9a9e"></div><span>å®å­</span></div>
    <div class="legend-item"><div class="legend-color" style="background:#6ecb63"></div><span>æœ€ä½³æ‹æ¡£</span></div>
    <div class="legend-item"><div class="legend-color" style="background:#4da6ff"></div><span>å°è‹—</span></div>
    <div class="legend-item"><div class="legend-color" style="background:#ffd166"></div><span>æŒšå‹</span></div>
    <div class="legend-item"><div class="legend-color" style="background:#db4dff"></div><span>é—ºèœœ</span></div>
    <div class="legend-item"><div class="legend-color" style="background:#5e60ce"></div><span>æ­»å…š</span></div>
  </div>
  <svg id="graph"></svg>
  <div class="tooltip"></div>
</div>

<script>
// ===================== é…ç½®åŒºï¼ˆä½ åªéœ€è¦ä¿®æ”¹è¿™éƒ¨åˆ†å†…å®¹ï¼‰ =====================
// ä¸­å¿ƒç”¨æˆ·ä¿¡æ¯
const centerUser = {
  id: "center",
  name: "å¼ ä¸‰",                // ä¸­å¿ƒç”¨æˆ·æ˜µç§°
  avatar: "https://via.placeholder.com/80?text=å¼ ä¸‰", // ä¸­å¿ƒç”¨æˆ·å¤´åƒ
  level: 50,                   // ä¸­å¿ƒç”¨æˆ·ç­‰çº§
  gender: "ç”·",                // ä¸­å¿ƒç”¨æˆ·æ€§åˆ«ï¼ˆæ–‡å­—ï¼‰
  title: "æ— æ•Œæˆ˜ç¥"            // ä¸­å¿ƒç”¨æˆ·ç§°å·
};

// å…³ç³»ç±»å‹æ˜ å°„ï¼ˆå·²ä¿®æ”¹åç§°ï¼‰
const relationTypeMap = {
  "0001": { type: "å®å­", color: "#ff9a9e" },    // CP â†’ å®å­
  "0002": { type: "æœ€ä½³æ‹æ¡£", color: "#6ecb63" },// å¸ˆçˆ¶ â†’ æœ€ä½³æ‹æ¡£
  "0003": { type: "å°è‹—", color: "#4da6ff" },    // å¾’å¼Ÿ â†’ å°è‹—
  "0004": { type: "æŒšå‹", color: "#ffd166" },    // æ­æ¡£ â†’ æŒšå‹
  "0005": { type: "é—ºèœœ", color: "#db4dff" },    // é—ºèœœï¼ˆä¸å˜ï¼‰
  "0006": { type: "æ­»å…š", color: "#5e60ce" }     // åŸºå‹ â†’ æ­»å…š
};

// å¥½å‹å…³ç³»æ•°æ®ï¼ˆæ ¸å¿ƒé…ç½®åŒºï¼‰
// gender: 1=ç”·, 2=å¥³, 0=ä¿å¯†; intimacy=äº²å¯†åº¦; id=å”¯ä¸€æ ‡è¯†ï¼ˆè‡ªå®šä¹‰å³å¯ï¼‰
const friendRelations = {
  "0001": [ // å®å­ï¼ˆåŸCPï¼‰
    { id: "f217", nickName: "æå››", avatarUrl: "https://via.placeholder.com/64?text=æå››", level: 45, gender: 2, intimacy: 217 }
  ],
  "0002": [ // æœ€ä½³æ‹æ¡£ï¼ˆåŸå¸ˆçˆ¶ï¼‰
    { id: "f100", nickName: "ç‹äº”", avatarUrl: "https://via.placeholder.com/64?text=ç‹äº”", level: 60, gender: 1, intimacy: 100 }
  ],
  "0003": [ // å°è‹—ï¼ˆåŸå¾’å¼Ÿï¼‰ - 10ä¸ªå¥½å‹
    { id: "f892", nickName: "å°è‹—1", avatarUrl: "https://via.placeholder.com/64?text=è‹—1", level: 30, gender: 2, intimacy: 892 },
    { id: "f695", nickName: "å°è‹—2", avatarUrl: "https://via.placeholder.com/64?text=è‹—2", level: 25, gender: 0, intimacy: 695 },
    { id: "f789", nickName: "å°è‹—3", avatarUrl: "https://via.placeholder.com/64?text=è‹—3", level: 28, gender: 1, intimacy: 789 },
    { id: "f456", nickName: "å°è‹—4", avatarUrl: "https://via.placeholder.com/64?text=è‹—4", level: 22, gender: 2, intimacy: 456 },
    { id: "f321", nickName: "å°è‹—5", avatarUrl: "https://via.placeholder.com/64?text=è‹—5", level: 29, gender: 0, intimacy: 321 },
    { id: "f987", nickName: "å°è‹—6", avatarUrl: "https://via.placeholder.com/64?text=è‹—6", level: 24, gender: 1, intimacy: 987 },
    { id: "f876", nickName: "å°è‹—7", avatarUrl: "https://via.placeholder.com/64?text=è‹—7", level: 27, gender: 2, intimacy: 876 },
    { id: "f543", nickName: "å°è‹—8", avatarUrl: "https://via.placeholder.com/64?text=è‹—8", level: 21, gender: 0, intimacy: 543 },
    { id: "f210", nickName: "å°è‹—9", avatarUrl: "https://via.placeholder.com/64?text=è‹—9", level: 31, gender: 1, intimacy: 210 },
    { id: "f198", nickName: "å°è‹—10", avatarUrl: "https://via.placeholder.com/64?text=è‹—10", level: 26, gender: 2, intimacy: 198 }
  ],
  "0004": [ // æŒšå‹ï¼ˆåŸæ­æ¡£ï¼‰ - 5ä¸ªå¥½å‹
    { id: "f234", nickName: "æŒšå‹1", avatarUrl: "https://via.placeholder.com/64?text=æŒš1", level: 48, gender: 1, intimacy: 234 },
    { id: "f235", nickName: "æŒšå‹2", avatarUrl: "https://via.placeholder.com/64?text=æŒš2", level: 47, gender: 2, intimacy: 321 },
    { id: "f236", nickName: "æŒšå‹3", avatarUrl: "https://via.placeholder.com/64?text=æŒš3", level: 46, gender: 1, intimacy: 456 },
    { id: "f237", nickName: "æŒšå‹4", avatarUrl: "https://via.placeholder.com/64?text=æŒš4", level: 45, gender: 2, intimacy: 589 },
    { id: "f238", nickName: "æŒšå‹5", avatarUrl: "https://via.placeholder.com/64?text=æŒš5", level: 44, gender: 0, intimacy: 612 }
  ],
  "0005": [ // é—ºèœœ - 5ä¸ªå¥½å‹
    { id: "f1403", nickName: "é—ºèœœ1", avatarUrl: "https://via.placeholder.com/64?text=é—º1", level: 42, gender: 2, intimacy: 1403 },
    { id: "f1404", nickName: "é—ºèœœ2", avatarUrl: "https://via.placeholder.com/64?text=é—º2", level: 41, gender: 2, intimacy: 1321 },
    { id: "f1405", nickName: "é—ºèœœ3", avatarUrl: "https://via.placeholder.com/64?text=é—º3", level: 40, gender: 1, intimacy: 1256 },
    { id: "f1406", nickName: "é—ºèœœ4", avatarUrl: "https://via.placeholder.com/64?text=é—º4", level: 39, gender: 2, intimacy: 1189 },
    { id: "f1407", nickName: "é—ºèœœ5", avatarUrl: "https://via.placeholder.com/64?text=é—º5", level: 38, gender: 0, intimacy: 1023 }
  ],
  "0006": [ // æ­»å…šï¼ˆåŸåŸºå‹ï¼‰ - 5ä¸ªå¥½å‹
    { id: "f531", nickName: "æ­»å…š1", avatarUrl: "https://via.placeholder.com/64?text=æ­»1", level: 49, gender: 1, intimacy: 531 },
    { id: "f532", nickName: "æ­»å…š2", avatarUrl: "https://via.placeholder.com/64?text=æ­»2", level: 48, gender: 1, intimacy: 621 },
    { id: "f533", nickName: "æ­»å…š3", avatarUrl: "https://via.placeholder.com/64?text=æ­»3", level: 47, gender: 0, intimacy: 756 },
    { id: "f534", nickName: "æ­»å…š4", avatarUrl: "https://via.placeholder.com/64?text=æ­»4", level: 46, gender: 1, intimacy: 889 },
    { id: "f535", nickName: "æ­»å…š5", avatarUrl: "https://via.placeholder.com/64?text=æ­»5", level: 45, gender: 2, intimacy: 912 }
  ]
};
// ===================== é…ç½®åŒºç»“æŸ =====================

// åˆå§‹åŒ–èŠ‚ç‚¹å’Œé“¾æ¥æ•°æ®
const nodes = [centerUser];
const links = [];

// å¤„ç†å¥½å‹æ•°æ®ï¼Œç”ŸæˆèŠ‚ç‚¹å’Œé“¾æ¥
Object.entries(friendRelations).forEach(([relationKey, friends]) => {
  const { type, color } = relationTypeMap[relationKey];
  friends.forEach(friend => {
    // å¤„ç†å¤´åƒé»˜è®¤å€¼å’Œæ€§åˆ«æ–‡å­—è½¬æ¢
    const avatarReal = friend.avatarUrl && !friend.avatarUrl.startsWith("avatar://") ? friend.avatarUrl : 
      `https://ui-avatars.com/api/?name=${encodeURIComponent(friend.nickName || "ç©å®¶")}&background=random&size=80`;
    const genderText = friend.gender === 0 ? "ä¿å¯†" : friend.gender === 1 ? "ç”·" : "å¥³";
    
    // æ·»åŠ å¥½å‹èŠ‚ç‚¹
    nodes.push({
      ...friend,
      name: friend.nickName,
      avatarReal,
      relationType: type,
      gender: genderText,
      title: "" // æ— ç§°å·æ—¶é»˜è®¤ç©º
    });
    
    // æ·»åŠ ä¸­å¿ƒç”¨æˆ·å’Œå¥½å‹çš„é“¾æ¥
    links.push({
      source: centerUser.id,
      target: friend.id,
      relationType: type,
      color: color,
      value: friend.intimacy
    });
  });
});

// åˆ›å»ºèƒŒæ™¯è£…é¥°å…ƒç´ 
const bg = d3.select("#bg-elements");
const emojis = ["ğŸ”¨", "ğŸ¥š", "ğŸ®", "â­", "ğŸ–ï¸"];
for (let i = 0; i < 25; i++) {
  bg.append("div").classed("bg-element", true)
    .style("font-size", `${Math.random() * 40 + 20}px`)
    .style("left", `${Math.random() * 100}%`)
    .style("top", `${Math.random() * 100}%`)
    .text(emojis[Math.floor(Math.random() * emojis.length)]);
}

// åˆå§‹åŒ–ç”»å¸ƒ
const width = window.innerWidth;
const height = window.innerHeight;
const svg = d3.select("#graph").attr("width", width).attr("height", height);
const container = svg.append("g");

// åˆå§‹åŒ–åŠ›å¯¼å‘å›¾
const simulation = d3.forceSimulation(nodes)
  .force("link", d3.forceLink(links).id(d => d.id).distance(d => {
    // ä¸åŒå…³ç³»è®¾ç½®ä¸åŒçš„èŠ‚ç‚¹é—´è·
    const distMap = { å®å­: 100, æœ€ä½³æ‹æ¡£: 180, å°è‹—: 220, æŒšå‹: 160, é—ºèœœ: 150, æ­»å…š: 170 };
    return distMap[d.relationType] || 180;
  }))
  .force("charge", d3.forceManyBody().strength(-300)) // èŠ‚ç‚¹æ’æ–¥åŠ›
  .force("center", d3.forceCenter(width / 2, height / 2)) // å±…ä¸­åŠ›
  .force("collision", d3.forceCollide().radius(d => d.id === "center" ? 80 : 50)); // ç¢°æ’æ£€æµ‹

// ç»˜åˆ¶é“¾æ¥ï¼ˆçº¿æ¡ï¼‰
const link = container.append("g").selectAll("line")
  .data(links).enter().append("line")
  .attr("stroke", d => d.color)
  .attr("stroke-width", 2)
  .attr("stroke-dasharray", "5,2")
  .attr("stroke-opacity", 0.6);

// ç»˜åˆ¶é“¾æ¥ä¸Šçš„äº²å¯†åº¦æ–‡å­—
const linkText = container.append("g").selectAll("text")
  .data(links).enter().append("text")
  .text(d => d.value)
  .attr("font-size", 12)
  .attr("font-weight", "bold")
  .attr("fill", "#2c3e50")
  .attr("pointer-events", "none");

// ç»˜åˆ¶èŠ‚ç‚¹
const node = container.append("g").selectAll("g")
  .data(nodes).enter().append("g")
  .attr("class", "node")
  // èŠ‚ç‚¹æ‹–æ‹½åŠŸèƒ½
  .call(d3.drag()
    .on("start", dragstarted)
    .on("drag", dragged)
    .on("end", dragended))
  // é¼ æ ‡æ‚¬æµ®æç¤º
  .on("mouseover", showTooltip)
  .on("mouseout", hideTooltip);

// èŠ‚ç‚¹åœ†å½¢èƒŒæ™¯
node.append("circle")
  .attr("r", d => d.id === "center" ? 40 : 32)
  .attr("fill", "#fff")
  .attr("stroke", d => {
    if (d.id === "center") return "#ff7979";
    const key = Object.keys(relationTypeMap).find(k => relationTypeMap[k].type === d.relationType);
    return key ? relationTypeMap[key].color : "#ccc";
  })
  .attr("stroke-width", 4);

// èŠ‚ç‚¹å¤´åƒ
const avatar = node.append("foreignObject")
  .attr("width", d => d.id === "center" ? 80 : 64)
  .attr("height", d => d.id === "center" ? 80 : 64)
  .attr("x", d => d.id === "center" ? -40 : -32)
  .attr("y", d => d.id === "center" ? -40 : -32);

avatar.append("xhtml:div").attr("class", "avatar-container")
  .html(d => {
    const avatarUrl = d.avatarReal || d.avatar || 
      `https://ui-avatars.com/api/?name=${encodeURIComponent(d.name || "ç©å®¶")}&background=random&size=80`;
    return `<img src="${avatarUrl}" class="avatar-image" 
            onerror="this.src='https://via.placeholder.com/60?text=${(d.name || d.nickName).slice(-2)}'">`;
  });

// éä¸­å¿ƒèŠ‚ç‚¹æ·»åŠ å…³ç³»ç±»å‹æ–‡å­—
node.filter(d => d.id !== "center")
  .append("text")
  .attr("dy", -12)
  .attr("text-anchor", "middle")
  .attr("fill", d => {
    const key = Object.keys(relationTypeMap).find(k => relationTypeMap[k].type === d.relationType);
    return key ? relationTypeMap[key].color : "#333";
  })
  .attr("font-weight", "bold")
  .text(d => d.relationType);

// éä¸­å¿ƒèŠ‚ç‚¹æ·»åŠ äº²å¯†åº¦æ–‡å­—
node.filter(d => d.id !== "center")
  .append("text")
  .attr("dy", 45)
  .attr("text-anchor", "middle")
  .attr("fill", "#ff6b6b")
  .attr("font-size", 14)
  .attr("font-weight", "bold")
  .text(d => d.intimacy);

// æ‹–æ‹½äº‹ä»¶å¤„ç†å‡½æ•°
function dragstarted(e, d) {
  if (!e.active) simulation.alphaTarget(0.3).restart();
  d.fx = d.x;
  d.fy = d.y;
}
function dragged(e, d) {
  d.fx = e.x;
  d.fy = e.y;
}
function dragended(e, d) {
  if (!e.active) simulation.alphaTarget(0);
  d.fx = null;
  d.fy = null;
}

// åŠ›å¯¼å‘å›¾tickäº‹ä»¶ï¼ˆæ¯ä¸€å¸§æ›´æ–°ä½ç½®ï¼‰
simulation.on("tick", () => {
  // æ›´æ–°é“¾æ¥ä½ç½®
  link.attr("x1", d => d.source.x).attr("y1", d => d.source.y)
      .attr("x2", d => d.target.x).attr("y2", d => d.target.y);
  // æ›´æ–°é“¾æ¥æ–‡å­—ä½ç½®
  linkText.attr("x", d => (d.source.x + d.target.x) / 2)
          .attr("y", d => (d.source.y + d.target.y) / 2 + 3);
  // æ›´æ–°èŠ‚ç‚¹ä½ç½®
  node.attr("transform", d => `translate(${d.x},${d.y})`);
});

// ç”»å¸ƒç¼©æ”¾åŠŸèƒ½
svg.call(d3.zoom()
  .scaleExtent([0.5, 3])
  .on("zoom", e => container.attr("transform", e.transform)));

// æç¤ºæ¡†æ˜¾ç¤ºå‡½æ•°
function showTooltip(e, d) {
  const tooltip = d3.select(".tooltip");
  // è·å–å…³ç³»ç±»å‹å¯¹åº”çš„é¢œè‰²
  let relationColor = "#333";
  if (d.id !== "center") {
    const key = Object.keys(relationTypeMap).find(k => relationTypeMap[k].type === d.relationType);
    relationColor = key ? relationTypeMap[key].color : "#333";
  }
  
  // æ„å»ºæç¤ºæ¡†å†…å®¹
  tooltip.html(`
    <div class="tooltip-header">
      <img src="${d.avatarReal || d.avatar}" class="tooltip-avatar" 
           onerror="this.src='https://via.placeholder.com/50?text=${(d.name || d.nickName).slice(-2)}'" 
           alt="${d.name || d.nickName}å¤´åƒ"/>
      <div>
        <div class="tooltip-name">${d.name || d.nickName}</div>
        <div class="tooltip-title">${d.title || "æ— ç§°å·"}</div>
      </div>
    </div>
    <div class="tooltip-info">
      <div>å…³ç³»: <b style="color:${relationColor}">${d.relationType || "è‡ªå·±"}</b></div>
      <div>ç­‰çº§: ${d.level}</div>
      ${d.intimacy ? `<div>äº²å¯†åº¦: <b>${d.intimacy}</b></div>` : ""}
      <div>æ€§åˆ«: ${d.gender || "ä¿å¯†"}</div>
    </div>
  `)
  .style("left", (e.pageX + 15) + "px")
  .style("top", (e.pageY - 15) + "px")
  .style("opacity", 1);
}

// æç¤ºæ¡†éšè—å‡½æ•°
function hideTooltip() {
  d3.select(".tooltip").style("opacity", 0);
}
</script>
</body>
</html>
